# Проблема маппинга статусов AlfaCRM для eCademy

## Дата диагностики
08.10.2025

## Проблема

При анализе 1498 лидов за сентябрь 2025 обнаружено:
- **89.2%** лидов в статусе "Не розібрані"
- **0 продаж** (статус "Купили (ЦА)")
- Метрики выглядят некорректно

## Диагностика

Запущен скрипт `scripts/check_alfacrm_statuses.py` для проверки реального маппинга.

### Результаты анализа 50 студентов из AlfaCRM:

#### Найдено 2 уникальных статуса:

| Status ID | Количество | Процент | Текущее название в маппинге | Примеры студентов |
|-----------|------------|---------|------------------------------|-------------------|
| **4** | 49 | 98% | "Назначений пробний" | Соболь Валерія, Кумлиш Ніна, Потапова Інесса |
| **39** | 1 | 2% | **ОТСУТСТВУЕТ В МАППИНГЕ** | Дяків Богдан |

#### Статусы из текущего маппинга, НЕ найденные в CRM:

- `1` - "Не розібрані"
- `2` - "Встанов. контакт (ЦА)"
- `3` - "В опрацюванні (ЦА)"
- `5` - "Проведений пробний"
- `6` - **"Купили (ЦА)"** ← 0 продаж из-за этого
- `7` - "Архів"
- `8` - "Недзвін"

## Причина проблемы

**У eCademy используется ДРУГАЯ настройка статусов в AlfaCRM**, отличная от стандартной.

Текущий маппинг в `app/services/alfacrm_tracking.py`:
```python
ALFACRM_STATUS_MAPPING = {
    1: "Не розібрані",
    2: "Встанов. контакт (ЦА)",
    3: "В опрацюванні (ЦА)",
    4: "Назначений пробний",     # ← ЕДИНСТВЕННЫЙ работающий
    5: "Проведений пробний",
    6: "Купили (ЦА)",             # ← НЕ найден в CRM
    7: "Архів",
    8: "Недзвін",
}
```

## Что это значит

1. **Статус ID 4** ("Назначений пробний") - единственный реально используемый (98% студентов)
2. **Статус ID 39** - существует в CRM, но не описан в маппинге
3. **Остальные статусы (1,2,3,5,6,7,8)** - не используются в этой конкретной CRM

Это объясняет почему:
- 89% лидов показываются как "Не розібрані" (дефолтный статус)
- 0 продаж (статус 6 не существует в реальной CRM)
- Воронка выглядит некорректно

## Необходимые действия

### 1. Получить от заказчика корректный справочник статусов

Нужно уточнить у eCademy:
- Полный список всех статусов лидов в их AlfaCRM
- ID каждого статуса
- Название каждого статуса на украинском
- Порядок статусов в воронке (от лида до продажи)

### 2. Варианты получения справочника:

**Вариант А: Попросить скриншот из AlfaCRM**
- Зайти в AlfaCRM → Настройки → Статусы лидов
- Сделать скриншот таблицы со всеми статусами и их ID

**Вариант Б: Экспортировать больше студентов**
- Увеличить `page_size=10000` в скрипте диагностики
- Проанализировать все уникальные `lead_status_id` в реальных данных
- Вручную уточнить названия для каждого найденного ID

**Вариант В: Прямой API запрос (если endpoint существует)**
- Попробовать `/v2api/lead-status/index` (возможно не поддерживается)

### 3. После получения корректного маппинга

1. Обновить `ALFACRM_STATUS_MAPPING` в `app/services/alfacrm_tracking.py`
2. Добавить статус 39 с правильным названием
3. Убрать неиспользуемые статусы или оставить как fallback
4. Перезапустить тесты на сентябрьских данных
5. Убедиться что метрики считаются корректно

## Временное решение

До получения корректного маппинга можно:
1. Оставить статус 4 как есть
2. Добавить статус 39 с placeholder-названием:
```python
ALFACRM_STATUS_MAPPING = {
    4: "Назначений пробний",
    39: "Інший статус (потребує уточнення)",  # TODO: уточнить название
    # ... остальные статусы как fallback
}
```

## Запуск диагностического скрипта

```bash
cd D:\Automation\Development\projects\ecademy
python scripts/check_alfacrm_statuses.py
```

Скрипт выводит:
- Текущий маппинг
- Реальные статусы в CRM
- Примеры студентов для каждого статуса
- Несоответствия между маппингом и реальностью

## Следующие шаги

1. **СРОЧНО**: Связаться с заказчиком для получения корректного маппинга
2. Обновить `ALFACRM_STATUS_MAPPING` после получения данных
3. Повторить тесты на сентябре
4. Проверить что метрики (продажи, конверсия) считаются правильно
