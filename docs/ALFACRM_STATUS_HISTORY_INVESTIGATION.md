# Дослідження історії статусів AlfaCRM

## Дата
09.10.2025

## Проблема
Потрібно отримати історію зміни статусів ліда в AlfaCRM API для правильного підрахунку метрик.

**Вимога користувача:**
> "а лід коли пройшов по воронці і поміняв 3 (наприклад) статуси - враховується в кожному з цих статусів як +1"

**Факт з Web UI:**
> "в самій срм при пошуку ліда по номеру телефону підсвічується в випадаючому списку всі статуси через які лід пройшов - вони відмічаються перекресленими але показуються"

## Дослідження API endpoints

### Спроба 1: `/v2api/customer/view`
**Результат:** 404 NOT FOUND
- Endpoint не існує в публічному API

### Спроба 2: `/v2api/customer/index` з фільтром phone
**Результат:** Повертає ТІЛЬКИ поточний статус
```json
{
  "id": 23294,
  "lead_status_id": 39,     // ← ТІЛЬКИ ПОТОЧНИЙ
  "study_status_id": 1,
  "pipeline_id": 2,
  // ... інші поля
}
```

**Немає полів:**
- `status_history`
- `lead_history`
- `timeline`
- `changes`

### Спроба 3: Інші можливі endpoints
Всі повертають 404:
- `/v2api/customer/timeline`
- `/v2api/customer/history`
- `/v2api/customer/status-history`
- `/v2api/customer/changes`
- `/v2api/lead/history`
- `/v2api/lead/timeline`
- `/v2api/customer/search`
- `/v2api/customer/autocomplete`
- `/v2api/lead/search`

## Варіанти рішення

### Варіант 1: Reverse Engineering Web UI (РЕКОМЕНДОВАНО)

**Мета:** Підглянути який endpoint використовує Web UI для відображення історії статусів.

**Інструкція для користувача:**

1. **Відкрити AlfaCRM Web UI в браузері**
2. **Відкрити Developer Tools** (F12)
3. **Перейти на вкладку Network**
4. **Виконати пошук ліда по телефону** (той де показуються перекреслені статуси)
5. **Знайти в Network запит який повертає історію статусів**
6. **Переслати деталі запиту:**
   - URL endpoint
   - HTTP метод (GET/POST)
   - Headers (особливо токен)
   - Request payload (якщо POST)
   - Response data (приклад відповіді)

**Очікуваний результат:**
Знайти endpoint типу:
- `/api/lead/get-status-history?customer_id=123`
- `/internal/customer/timeline?id=123`
- або подібний

### Варіант 2: Логічний cumulative count (БЕЗ історії)

**Логіка:** Якщо лід має статус "Отримана оплата" (ID 39), він ОБОВ'ЯЗКОВО пройшов попередні статуси воронки.

**Послідовність воронки (припущення):**
```python
FUNNEL_SEQUENCE = {
    # Pipeline 1 (основна воронка)
    11: 1,   # "Недодзвон" - рівень 1
    10: 2,   # "Недозвон 2" - рівень 2
    32: 3,   # "Вст контакт зацікавлений" - рівень 3
    12: 4,   # "Розмовляли, чекаємо відповідь" - рівень 4
    2: 5,    # "Призначено пробне" - рівень 5
    3: 6,    # "Проведено пробне" - рівень 6
    9: 7,    # "Чекаємо оплату" - рівень 7
    4: 8,    # "Отримана оплата" - рівень 8 (КІНЕЦЬ)

    # Pipeline 2 (друга воронка)
    18: 1,   # "Недозвон" - рівень 1
    40: 2,   # "Недозвон 2" - рівень 2
    22: 3,   # "Встан контакт зацікавлений" - рівень 3
    24: 4,   # "Розмовляли чекаємо відповіді" - рівень 4
    35: 5,   # "Призначено пробне" - рівень 5
    37: 6,   # "Проведено пробне" - рівень 6
    38: 7,   # "Чекає оплату" - рівень 7
    39: 8,   # "Отримана оплата" - рівень 8 (КІНЕЦЬ)
}
```

**Алгоритм підрахунку:**
```python
def count_leads_cumulative(leads, student_index):
    """
    Підраховує ліди через які статуси вони пройшли (логічно).
    """
    status_counts = defaultdict(int)

    for lead in leads:
        student = find_student_by_contact(lead, student_index)
        if not student:
            status_counts["Не розібраний"] += 1
            continue

        current_status_id = student.get("lead_status_id")
        current_level = FUNNEL_SEQUENCE.get(current_status_id, 0)

        # Якщо лід досяг рівня 8 (Оплата), він пройшов ВСІ попередні рівні
        for status_id, level in FUNNEL_SEQUENCE.items():
            if level <= current_level:
                status_name = ALFACRM_STATUS_MAPPING[status_id]
                status_counts[status_name] += 1

    return status_counts
```

**Переваги:**
- ✅ Працює БЕЗ додаткових API запитів
- ✅ Логічна послідовність воронки
- ✅ Простота реалізації

**Недоліки:**
- ❌ Припускає лінійний прогрес через воронку
- ❌ НЕ враховує "перескоки" статусів
- ❌ Потребує точної послідовності воронки

### Варіант 3: Запит до підтримки AlfaCRM

Написати в підтримку AlfaCRM з запитом:

> Чи є в AlfaCRM API endpoint для отримання історії зміни статусів ліда (lead_status_id)?
> В Web UI при пошуку ліда показуються всі пройдені статуси (перекреслені).
> Потрібно отримати ці дані через API для аналітики.

## Рекомендації

**ПРІОРИТЕТ 1:** Виконати Reverse Engineering Web UI (Варіант 1)
- Це найточніший спосіб
- Знайдемо реальний endpoint який використовує Web UI
- Отримаємо ТОЧНУ історію статусів

**ПРІОРИТЕТ 2:** Реалізувати Варіант 2 (Логічний cumulative count) як тимчасове рішення
- Працює зараз без додаткових досліджень
- Дає наближені але розумні результати

**ПРІОРИТЕТ 3:** Запит до підтримки AlfaCRM (паралельно з Варіантом 1)
- Можливо існує документований endpoint якого ми не знаємо

## Інструкція для користувача (Reverse Engineering)

### Крок 1: Відкрити AlfaCRM Web UI
1. Перейти на https://[your-domain].s20.online/
2. Авторизуватись

### Крок 2: Відкрити Developer Tools
1. Натиснути F12 (або Ctrl+Shift+I)
2. Перейти на вкладку **Network**
3. Включити фільтр **XHR** (щоб бачити тільки API запити)

### Крок 3: Виконати пошук ліда
1. В AlfaCRM знайти поле пошуку ліда по телефону
2. Ввести тестовий номер телефону (наприклад: +380504007062)
3. Подивитись на випадаючий список де показуються перекреслені статуси

### Крок 4: Знайти запит в Network
1. В вкладці Network знайти запит який виконався під час пошуку
2. Клікнути на запит
3. Переглянути:
   - **Headers** → Request URL (скопіювати)
   - **Headers** → Request Method (GET/POST)
   - **Payload** (якщо POST) → скопіювати JSON
   - **Response** → скопіювати JSON відповідь

### Крок 5: Переслати дані
Створити файл з деталями запиту:

```
ENDPOINT: [URL запиту]
METHOD: [GET або POST]
HEADERS:
  X-ALFACRM-TOKEN: [токен]
  ... інші headers

PAYLOAD (якщо POST):
{
  "customer_id": 123,
  ...
}

RESPONSE:
{
  "status_history": [...],
  ...
}
```

## Очікуваний результат

Після знаходження правильного endpoint, ми зможемо:

1. **Отримати повну історію статусів кожного ліда**
2. **Точно порахувати скільки лідів пройшло через кожен статус**
3. **Оновити UI таблиці з реальними даними**

**Приклад очікуваного response:**
```json
{
  "customer_id": 23294,
  "current_status_id": 39,
  "status_history": [
    {
      "status_id": 11,
      "status_name": "Недодзвон",
      "changed_at": "2025-08-01 08:00:00"
    },
    {
      "status_id": 32,
      "status_name": "Вст контакт зацікавлений",
      "changed_at": "2025-08-02 10:00:00"
    },
    {
      "status_id": 2,
      "status_name": "Призначено пробне",
      "changed_at": "2025-08-05 14:00:00"
    },
    {
      "status_id": 39,
      "status_name": "Отримана оплата",
      "changed_at": "2025-08-10 16:00:00"
    }
  ]
}
```

## Статус дослідження

- ✅ Перевірено всі стандартні API endpoints - НЕ знайдено історію
- ⏳ Очікується Reverse Engineering Web UI від користувача
- ⏳ Розробка Варіанту 2 (Логічний cumulative) як fallback

## Наступні кроки

1. **Користувач:** Виконати Reverse Engineering Web UI (інструкція вище)
2. **Розробник:** Реалізувати Варіант 2 (Логічний cumulative) паралельно
3. **Розробник:** Написати запит в підтримку AlfaCRM
